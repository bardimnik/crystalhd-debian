#!/usr/bin/make -f

UPSTREAM_VERSION = $(shell dpkg-parsechangelog | grep -G '^Version' | \
                     cut -d ' ' -f 2 | sed 's/^[^:]:*//' | sed 's/-.*$$//')

%:
	dh --with quilt,dkms $@

override_dh_auto_build:
	make -C linux_lib/libcrystalhd
	cd filters/gst/gst-plugin && ./configure --prefix=/usr
	make -C filters/gst/gst-plugin

override_dh_auto_install:
	make install -C linux_lib/libcrystalhd DESTDIR=$(CURDIR)/debian/tmp
	make install -C filters/gst/gst-plugin DESTDIR=$(CURDIR)/debian/tmp
	mkdir -p $(CURDIR)/debian/tmp/usr/src/crystalhd-$(UPSTREAM_VERSION)
	cp -rf driver $(CURDIR)/debian/tmp/usr/src/crystalhd-$(UPSTREAM_VERSION)
	cp -rf include $(CURDIR)/debian/tmp/usr/src/crystalhd-$(UPSTREAM_VERSION)

override_dh_auto_clean:
	dh_clean
	make clean -C linux_lib/libcrystalhd
	[ ! -f filters/gst/gst-plugin/Makefile ] || \
		make clean distclean -C filters/gst/gst-plugin

override_dh_dkms:
	dh_dkms -V $(UPSTREAM_VERSION)
